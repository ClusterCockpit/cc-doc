---
title: How to generate JWT tokens
categories: [cc-backend, cc-metric-store, cc-metric-collector]
tags: [User, Admin, Developer]
---

## Overview
ClusterCockpit uses JSON Web Tokens (JWT) for authorization of its APIs.
JWTs are the industry standard for securing APIs and is also used for example in
OAuth2. For details on JWTs refer to the [JWT article](/docs/concepts/jwtoken)
in the Concepts section.

When a user logs in via the `/login` page using a browser, a session cookie
(secured using the random bytes in the `SESSION_KEY` env variable you should
change as well in production) is used for all requests after the successful
login. The JWTs make it easier to use the APIs of ClusterCockpit using scripts
or other external programs. The token is specified n the `Authorization` HTTP
header using the [Bearer schema](https://datatracker.ietf.org/doc/html/rfc6750)
(there is an example below). Tokens can be issued to users from the
configuration view in the Web-UI or the command line (using the `-jwt
<username>` option). In order to use the token for API endpoints such as
`/api/jobs/start_job/`, the user that executes it needs to have the `api` role.
Regular users can only perform read-only queries and only look at data connected
to jobs they started themselves.

There are two usage scenarios:

* The APIs are used during a browser session. API accesses are authorized with
  the active session.
* The REST API is used outside a browser session, e.g. by scripts. In this case
  you have to issue a token manually. This possible from within the
  configuration view or on the command line. It is recommended to issue a JWT
  token in this case for a special user that only has the `api` role. By using
  different users for different purposes a fine grained access control and
  access revocation management is possible.

The token is commonly specified in the Authorization HTTP header using the
Bearer schema. ClusterCockpit uses a ECDSA private/public keypair to sign and
verify its tokens. You can use `cc-backend` to generate new JWT tokens.

## Workflow

### Create a new ECDSA Public/private key pair for signing and validating tokens

We provide a small utility tool as part of `cc-backend`:

```bash
go build ./cmd/gen-keypair/
./gen-keypair
```

### Add key pair in your `.env` file for `cc-backend`

An env file template can be found in `./configs`.
`cc-backend` requires the private key to sign newly generated JWT tokens and the
public key to validate tokens used to authenticate in its REST APIs.

### Generate new JWT token

Every user with the admin role can create or change a user in the configuration
view of the web interface. To generate a new JWT for a user just press the
GenJWT button behind the user name in the user list.

A new api user and corresponding JWT keys can also be generated from the command
line.

Create new API user with admin and api role:

```bash
./cc-backend -add-user myapiuser:admin,api:<password>
```

Create a new JWT token for this user:

```bash
./cc-backend -jwt myapiuser
```

### Use issued token token on client side

```bash
curl -X GET "<API ENDPOINT>" -H "accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer <JWT TOKEN>"
```

This token can be used for the `cc-backend` REST API as well as for the
`cc-metric-store`. If you use the token for `cc-metric-store` you have to
configure it to use the corresponding public key for validation in its
config.json.

{{< alert color="danger" title="Note" >}}
Per default the JWT tokens generated by cc-backend will not expire! To set an
expiration date you have to configure an expiration duration in `config.json`.
You find details [here](/docs/reference/cc-backend/configuration/#configuration-options),
use keys `jwts`:`max-age`.
{{< /alert >}}

Of course the JWT token can be generated also by other means as long it is
signed with a ED25519 private key and the corresponding public key is configured
in `cc-backend` or `cc-metric-store`. For the claims that are set and used by
ClusterCockpit refer to the [JWT article](/docs/concepts/jwtoken).

## cc-metric-store

The [cc-metric-store](https://github.com/ClusterCockpit/cc-metric-store) also
uses JWTs for authentication. As it does not issue new tokens, it does not need
to kown the private key. The public key of the keypair that is used to generate
the JWTs that grant access to the `cc-metric-store` can be specified in its
`config.json`. When configuring the `metricDataRepository` object in the
`cluster.json` file of the job-archive, you can put a token issued by
`cc-backend` itself.
